# Инструкция по экспорту объектов PostgreSQL

## Что это?

Я создал для вас два скрипта, которые позволяют экспортировать каждый объект вашей базы данных PostgreSQL в отдельный файл с валидным DDL кодом:

1. **pg_dump_objects.sh** - простой Bash-скрипт
2. **pg_dump_objects.py** - продвинутый Python-скрипт

## Быстрый старт

### Вариант 1: Bash-скрипт (простой)

```bash
# Минимальный запуск
DB_NAME=mydb DB_USER=myuser ./pg_dump_objects.sh

# С паролем
DB_NAME=mydb DB_USER=myuser DB_PASSWORD=mypass ./pg_dump_objects.sh

# Для удаленной базы
DB_NAME=mydb DB_USER=myuser DB_HOST=server.com DB_PORT=5432 ./pg_dump_objects.sh
```

### Вариант 2: Python-скрипт (продвинутый)

Сначала установите зависимость:
```bash
pip install psycopg2-binary
```

Затем запустите:
```bash
# Минимальный запуск
python pg_dump_objects.py -d mydb -U myuser

# С запросом пароля
python pg_dump_objects.py -d mydb -U myuser -W

# Для удаленной базы
python pg_dump_objects.py -d mydb -U myuser -h server.com -p 5432
```

## Что будет экспортировано?

Каждый скрипт создаст директорию `database_export` со следующей структурой:

```
database_export/
├── schemas/         # CREATE SCHEMA команды
├── tables/          # CREATE TABLE команды (с ограничениями)
├── views/           # CREATE VIEW команды
├── functions/       # CREATE FUNCTION команды
├── procedures/      # CREATE PROCEDURE команды (PostgreSQL 11+)
├── sequences/       # CREATE SEQUENCE команды
├── types/           # Пользовательские типы (ENUM, композитные, домены)
├── triggers/        # CREATE TRIGGER команды
├── indexes/         # CREATE INDEX команды
└── extensions/      # CREATE EXTENSION команды
```

## Примеры файлов

### Таблица (tables/public/users.sql):
```sql
CREATE TABLE "public"."users" (
    "id" integer GENERATED BY DEFAULT AS IDENTITY,
    "email" character varying(255) NOT NULL,
    "name" character varying(100),
    "created_at" timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "users_pkey" PRIMARY KEY ("id"),
    CONSTRAINT "users_email_key" UNIQUE ("email")
);

COMMENT ON TABLE "public"."users" IS 'Таблица пользователей';
COMMENT ON COLUMN "public"."users"."email" IS 'Email пользователя';
```

### Функция (functions/public/get_user_by_id.sql):
```sql
CREATE OR REPLACE FUNCTION public.get_user_by_id(user_id integer)
 RETURNS TABLE(id integer, email character varying, name character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT u.id, u.email, u.name
    FROM users u
    WHERE u.id = user_id;
END;
$function$;
```

## Восстановление из файлов

### Восстановить всю структуру:
```bash
# Создать новую базу
createdb -U postgres newdb

# Восстановить все объекты в правильном порядке
for dir in extensions schemas types sequences tables views functions procedures triggers indexes; do
    find ./database_export/$dir -name "*.sql" -exec psql -U postgres -d newdb -f {} \;
done
```

### Восстановить отдельный объект:
```bash
# Восстановить конкретную таблицу
psql -U postgres -d mydb -f ./database_export/tables/public/users.sql

# Восстановить конкретную функцию
psql -U postgres -d mydb -f ./database_export/functions/public/get_user_by_id.sql
```

## Какой скрипт выбрать?

### Используйте Bash-скрипт если:
- Нужно быстро сделать экспорт
- Нет возможности установить Python-пакеты
- База данных относительно простая

### Используйте Python-скрипт если:
- Нужна детальная обработка всех объектов
- Важны комментарии к объектам
- Нужно лучшее логирование
- База данных сложная с множеством зависимостей

## Важные замечания

1. **Только структура** - скрипты НЕ экспортируют данные, только DDL
2. **Без прав доступа** - GRANT/REVOKE команды не экспортируются
3. **Без владельцев** - информация о владельцах объектов не сохраняется
4. **Порядок важен** - при восстановлении соблюдайте порядок (сначала схемы, потом таблицы и т.д.)

## Использование для контроля версий

Эти скрипты отлично подходят для хранения структуры БД в Git:

```bash
# Экспортировать структуру
python pg_dump_objects.py -d production -U postgres

# Добавить в Git
cd database_export
git init
git add .
git commit -m "Структура БД на $(date +%Y-%m-%d)"
```

## Проблемы и решения

### "psql: command not found"
Установите PostgreSQL клиент:
```bash
# Ubuntu/Debian
sudo apt-get install postgresql-client

# CentOS/RHEL
sudo yum install postgresql
```

### "ModuleNotFoundError: No module named 'psycopg2'"
Установите модуль:
```bash
pip install psycopg2-binary
```

### "FATAL: password authentication failed"
Используйте правильный пароль или настройте pg_hba.conf для доверенного подключения.

## Контакты

Если возникнут вопросы по использованию скриптов, обращайтесь!